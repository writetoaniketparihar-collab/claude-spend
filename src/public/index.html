<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Claude Spend</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap');

  *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

  :root {
    --bg: #F8F9FC;
    --bg-mesh-1: #EEF0FF;
    --bg-mesh-2: #F0FDFA;
    --white: #FFFFFF;
    --text: #0F172A;
    --text-secondary: #475569;
    --text-tertiary: #94A3B8;
    --border: rgba(0,0,0,0.06);
    --border-strong: rgba(0,0,0,0.1);

    --indigo: #6366F1;
    --violet: #8B5CF6;
    --purple: #A855F7;
    --teal: #14B8A6;
    --cyan: #06B6D4;
    --emerald: #10B981;
    --amber: #F59E0B;
    --orange: #F97316;
    --rose: #F43F5E;
    --blue: #3B82F6;

    --gradient-main: linear-gradient(135deg, #6366F1, #8B5CF6, #A855F7);
    --gradient-teal: linear-gradient(135deg, #14B8A6, #06B6D4);
    --gradient-warm: linear-gradient(135deg, #F59E0B, #F97316);
    --gradient-rose: linear-gradient(135deg, #F43F5E, #EC4899);

    --shadow-sm: 0 1px 2px rgba(0,0,0,0.04);
    --shadow-md: 0 4px 16px rgba(0,0,0,0.06);
    --shadow-lg: 0 8px 32px rgba(0,0,0,0.08);
    --shadow-glow: 0 0 40px rgba(99,102,241,0.15);

    --radius: 16px;
    --radius-sm: 10px;
    --radius-xs: 6px;
    --font: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif;
    --mono: 'SF Mono', 'Cascadia Code', 'Fira Code', 'JetBrains Mono', monospace;
  }

  body {
    font-family: var(--font);
    background: var(--bg);
    color: var(--text);
    line-height: 1.6;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Mesh gradient background */
  body::before {
    content: '';
    position: fixed; top: 0; left: 0; right: 0; height: 600px;
    background:
      radial-gradient(ellipse 80% 60% at 10% 0%, rgba(99,102,241,0.12) 0%, transparent 60%),
      radial-gradient(ellipse 60% 50% at 90% 10%, rgba(139,92,246,0.08) 0%, transparent 50%),
      radial-gradient(ellipse 50% 40% at 50% 20%, rgba(20,184,166,0.06) 0%, transparent 50%);
    pointer-events: none; z-index: 0;
  }

  /* Loading */
  .loading {
    display: flex; align-items: center; justify-content: center;
    min-height: 100vh; flex-direction: column; gap: 20px;
  }
  .spinner {
    width: 36px; height: 36px;
    border: 3px solid var(--border); border-top-color: var(--indigo);
    border-radius: 50%; animation: spin 0.7s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }
  .loading-text { color: var(--text-secondary); font-size: 15px; font-weight: 500; }

  /* Layout */
  .container { max-width: 1200px; margin: 0 auto; padding: 40px 28px 60px; position: relative; z-index: 1; }

  /* Fade-in animation */
  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(16px); }
    to { opacity: 1; transform: translateY(0); }
  }
  .animate { animation: fadeUp 0.5s ease-out both; }
  .delay-1 { animation-delay: 0.05s; }
  .delay-2 { animation-delay: 0.1s; }
  .delay-3 { animation-delay: 0.15s; }
  .delay-4 { animation-delay: 0.2s; }
  .delay-5 { animation-delay: 0.25s; }

  /* ---- HEADER ---- */
  .header {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 40px; flex-wrap: wrap; gap: 16px;
  }
  .header-left { display: flex; align-items: center; gap: 14px; }
  .logo-mark {
    width: 40px; height: 40px; border-radius: 12px;
    background: var(--gradient-main);
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 4px 12px rgba(99,102,241,0.3);
  }
  .logo-mark svg { width: 22px; height: 22px; }
  .header h1 { font-size: 22px; font-weight: 800; letter-spacing: -0.5px; }
  .header-right { display: flex; align-items: center; gap: 14px; }
  .date-range {
    color: var(--text-tertiary); font-size: 13px; font-weight: 500;
    background: var(--white); padding: 6px 14px; border-radius: 20px;
    border: 1px solid var(--border);
  }
  .refresh-btn {
    background: var(--white); border: 1px solid var(--border);
    color: var(--text-secondary); padding: 7px 16px; border-radius: 20px;
    cursor: pointer; font-size: 13px; font-weight: 500; font-family: var(--font);
    transition: all 0.2s; display: flex; align-items: center; gap: 6px;
  }
  .refresh-btn:hover {
    border-color: var(--indigo); color: var(--indigo);
    box-shadow: 0 2px 8px rgba(99,102,241,0.12);
  }
  .refresh-btn svg { width: 14px; height: 14px; }

  /* ---- STAT CARDS ---- */
  .stats-row {
    display: grid; grid-template-columns: repeat(4, 1fr);
    gap: 16px; margin-bottom: 32px;
  }
  @media (max-width: 780px) { .stats-row { grid-template-columns: repeat(2, 1fr); } }

  .stat-card {
    background: var(--white); border-radius: var(--radius);
    padding: 24px; position: relative;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-sm);
    transition: box-shadow 0.2s, transform 0.2s;
  }
  .stat-card:hover { box-shadow: var(--shadow-md); }
  .stat-card .accent-bar {
    position: absolute; top: 0; left: 0; right: 0; height: 3px;
  }
  .stat-label {
    font-size: 12px; font-weight: 600; color: var(--text-tertiary);
    text-transform: uppercase; letter-spacing: 0.6px; margin-bottom: 10px;
  }
  .stat-value {
    font-size: 34px; font-weight: 800; letter-spacing: -2px;
    line-height: 1; margin-bottom: 6px;
    color: var(--text);
  }
  .stat-sub { font-size: 13px; color: var(--text-tertiary); font-weight: 500; }

  /* Tooltips */
  .has-tooltip {
    position: relative;
    cursor: help;
  }
  .has-tooltip .tooltip {
    position: absolute;
    bottom: calc(100% + 10px);
    left: 50%;
    transform: translateX(-50%);
    background: var(--text);
    color: #F8FAFC;
    font-size: 12px;
    font-weight: 500;
    line-height: 1.5;
    padding: 10px 14px;
    border-radius: 10px;
    white-space: normal;
    width: max-content;
    max-width: 280px;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.15s, transform 0.15s;
    transform: translateX(-50%) translateY(4px);
    z-index: 100;
    box-shadow: 0 8px 24px rgba(0,0,0,0.15);
    text-transform: none;
    letter-spacing: 0;
    text-align: left;
  }
  .has-tooltip .tooltip::after {
    content: '';
    position: absolute;
    top: 100%;
    left: 50%;
    transform: translateX(-50%);
    border: 6px solid transparent;
    border-top-color: var(--text);
  }
  .has-tooltip:hover .tooltip {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
  /* For table headers, tooltip goes below */
  .has-tooltip-below .tooltip {
    bottom: auto;
    top: calc(100% + 10px);
  }
  .has-tooltip-below .tooltip::after {
    top: auto;
    bottom: 100%;
    border-top-color: transparent;
    border-bottom-color: var(--text);
  }
  /* Help icon next to labels */
  .help-icon {
    display: inline-flex;
    align-items: center;
    justify-content: center;
    width: 15px;
    height: 15px;
    border-radius: 50%;
    background: rgba(0,0,0,0.06);
    color: var(--text-tertiary);
    font-size: 10px;
    font-weight: 700;
    margin-left: 5px;
    vertical-align: middle;
    flex-shrink: 0;
  }

  /* Token explainer */
  /* ---- SECTION HEADINGS ---- */
  .section-header {
    display: flex; align-items: center; gap: 10px;
    margin-bottom: 16px;
  }
  .section-icon {
    width: 28px; height: 28px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0;
  }
  .section-icon svg { width: 16px; height: 16px; }
  .section-title {
    font-size: 16px; font-weight: 700; letter-spacing: -0.3px;
  }

  /* ---- INSIGHTS ---- */
  .insights-section { margin-bottom: 32px; }
  .insight-card {
    background: var(--white); border-radius: var(--radius-sm);
    padding: 14px 20px; margin-bottom: 8px;
    border: 1px solid var(--border);
    box-shadow: var(--shadow-sm);
    cursor: pointer; transition: box-shadow 0.2s;
  }
  .insight-card:hover { box-shadow: var(--shadow-md); }
  .insight-top {
    display: flex; align-items: center; gap: 12px;
  }
  .insight-arrow {
    margin-left: auto; flex-shrink: 0;
    width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;
    color: var(--text-tertiary); transition: transform 0.25s ease;
  }
  .insight-card.expanded .insight-arrow { transform: rotate(180deg); }
  .insight-indicator {
    width: 28px; height: 28px; border-radius: 8px;
    display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; font-size: 14px;
  }
  .insight-card.warning .insight-indicator { background: linear-gradient(135deg, #FEF3C7, #FDE68A); }
  .insight-card.info .insight-indicator { background: linear-gradient(135deg, #E0E7FF, #C7D2FE); }
  .insight-card.neutral .insight-indicator { background: linear-gradient(135deg, #F1F5F9, #E2E8F0); }
  .insight-title { font-size: 14px; font-weight: 700; line-height: 1.4; }
  .insight-oneliner { font-size: 13px; color: var(--text-secondary); margin-left: auto; white-space: nowrap; font-weight: 500; }
  .insight-expand {
    max-height: 0; overflow: hidden; transition: max-height 0.3s ease;
  }
  .insight-card.expanded .insight-expand { max-height: 300px; }
  .insight-detail {
    font-size: 13px; color: var(--text-secondary); line-height: 1.65;
    padding: 12px 0 4px 40px;
    border-top: 1px solid var(--border); margin-top: 12px;
  }
  .insight-action-tip {
    font-size: 13px; line-height: 1.6;
    padding: 8px 0 0 40px; color: var(--indigo); font-weight: 600;
  }

  /* ---- CHARTS ---- */
  .charts-grid {
    display: grid; grid-template-columns: 5fr 2fr;
    gap: 16px; margin-bottom: 32px;
  }
  @media (max-width: 800px) { .charts-grid { grid-template-columns: 1fr; } }

  .chart-card {
    background: var(--white); border-radius: var(--radius);
    padding: 24px; border: 1px solid var(--border);
    box-shadow: var(--shadow-sm);
  }
  .chart-card h3 {
    font-size: 13px; font-weight: 700; color: var(--text-tertiary);
    text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 20px;
  }
  canvas { display: block; }
  .legend {
    display: flex; gap: 20px; margin-top: 16px;
    font-size: 12px; font-weight: 500; color: var(--text-secondary);
  }
  .legend-item { display: flex; align-items: center; gap: 7px; }
  .legend-dot { width: 10px; height: 10px; border-radius: 4px; flex-shrink: 0; }

  /* ---- TOP PROMPTS ---- */
  .top-prompts { margin-bottom: 32px; }
  .prompts-card {
    background: var(--white); border-radius: var(--radius);
    border: 1px solid var(--border); box-shadow: var(--shadow-sm);
    overflow: hidden;
  }
  .prompt-row {
    display: grid; grid-template-columns: 36px 1fr auto;
    gap: 14px; padding: 16px 24px; align-items: start;
    border-bottom: 1px solid var(--border);
    cursor: pointer; transition: background 0.15s;
  }
  .prompt-row:last-child { border-bottom: none; }
  .prompt-row:hover { background: #FAFBFF; }
  .prompt-rank {
    width: 28px; height: 28px; border-radius: 8px;
    background: var(--bg); display: flex; align-items: center; justify-content: center;
    font-size: 12px; font-weight: 700; color: var(--text-secondary);
  }
  .prompt-row:nth-child(1) .prompt-rank { background: var(--gradient-main); color: white; }
  .prompt-row:nth-child(2) .prompt-rank { background: var(--gradient-teal); color: white; }
  .prompt-row:nth-child(3) .prompt-rank { background: var(--gradient-warm); color: white; }
  .prompt-text {
    font-size: 14px; font-weight: 500; line-height: 1.5;
    display: -webkit-box; -webkit-line-clamp: 2;
    -webkit-box-orient: vertical; overflow: hidden;
  }
  .prompt-meta { font-size: 12px; color: var(--text-tertiary); margin-top: 4px; font-weight: 500; }
  .token-bar-wrap {
    display: flex; gap: 1px; height: 4px; margin-top: 8px;
    border-radius: 4px; overflow: hidden;
  }
  .token-bar-in { background: var(--indigo); height: 100%; }
  .token-bar-cache { background: var(--amber); height: 100%; }
  .token-bar-out { background: var(--teal); height: 100%; }
  .prompt-tokens { text-align: right; white-space: nowrap; padding-top: 2px; }
  .prompt-tokens .value {
    font-size: 16px; font-weight: 700; font-family: var(--mono);
    letter-spacing: -0.5px;
  }
  .prompt-tokens .sub { font-size: 11px; color: var(--text-tertiary); font-weight: 500; margin-top: 2px; }

  /* ---- PROJECTS ---- */
  .projects-section { margin-bottom: 32px; }

  /* Project accordion */
  .proj-chevron {
    width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center;
    color: var(--text-tertiary); transition: transform 0.25s ease; flex-shrink: 0;
  }
  .proj-row { cursor: pointer; }
  .proj-row:hover td { background: #FAFBFF; }
  .proj-row.expanded .proj-chevron { transform: rotate(90deg); }
  .proj-drawer td { padding: 0; border-bottom: 1px solid var(--border); }
  .proj-drawer-inner { max-height: 0; overflow: hidden; transition: max-height 0.35s ease; background: #FAFBFC; }
  .proj-drawer.open .proj-drawer-inner { max-height: 600px; }
  .proj-drawer-content { padding: 12px 16px 16px; }
  .drawer-prompt-list { display: flex; flex-direction: column; gap: 8px; }
  .drawer-prompt-row {
    display: grid; grid-template-columns: 24px 1fr auto;
    gap: 10px; padding: 10px 14px; align-items: start;
    background: white; border: 1px solid var(--border); border-radius: 10px;
    cursor: pointer; transition: box-shadow 0.15s;
  }
  .drawer-prompt-row:hover { box-shadow: var(--shadow-md); }
  .drawer-rank {
    width: 20px; height: 20px; border-radius: 6px;
    background: var(--bg); display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700; color: var(--text-secondary); flex-shrink: 0;
  }
  .drawer-prompt-text {
    font-size: 13px; font-weight: 500; line-height: 1.5;
    display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden;
    word-break: break-word;
  }
  .drawer-prompt-meta { display: flex; flex-wrap: wrap; gap: 4px; align-items: center; margin-top: 5px; }
  .tool-chip {
    background: var(--bg); border: 1px solid var(--border-strong);
    padding: 1px 7px; border-radius: 6px; font-size: 10px; font-weight: 600;
    color: var(--text-secondary); white-space: nowrap;
  }
  .drawer-tokens { text-align: right; white-space: nowrap; }
  .drawer-tokens .value { font-family: var(--mono); font-size: 14px; font-weight: 700; }
  .drawer-tokens .sub { font-size: 11px; color: var(--text-tertiary); font-weight: 500; margin-top: 2px; }
  .drawer-empty { text-align: center; padding: 20px; color: var(--text-tertiary); font-size: 13px; font-weight: 500; }

  /* ---- SESSIONS ---- */
  .sessions-section { margin-bottom: 40px; }
  .sessions-toolbar {
    display: flex; align-items: center; justify-content: space-between;
    margin-bottom: 14px; gap: 12px; flex-wrap: wrap;
  }
  .session-search {
    background: var(--white); border: 1px solid var(--border);
    color: var(--text); padding: 9px 16px; border-radius: 10px;
    font-size: 14px; font-weight: 500; width: 300px; outline: none;
    font-family: var(--font); transition: all 0.2s;
  }
  .session-search::placeholder { color: var(--text-tertiary); }
  .session-search:focus { border-color: var(--indigo); box-shadow: 0 0 0 3px rgba(99,102,241,0.1); }
  .session-count { color: var(--text-tertiary); font-size: 13px; font-weight: 600; }

  .sessions-card {
    background: var(--white); border-radius: var(--radius);
    border: 1px solid var(--border); box-shadow: var(--shadow-sm);
    overflow: visible;
  }
  .sessions-table { width: 100%; border-collapse: collapse; font-size: 14px; }
  .sessions-table th {
    text-align: left; padding: 12px 16px;
    font-size: 11px; font-weight: 700; text-transform: uppercase;
    letter-spacing: 0.6px; color: var(--text-tertiary);
    border-bottom: 1px solid var(--border);
    cursor: pointer; user-select: none; white-space: nowrap;
    background: #FAFBFC;
  }
  .sessions-table th:hover { color: var(--text-secondary); }
  .sessions-table th.sorted { color: var(--indigo); }
  .sessions-table td {
    padding: 12px 16px; border-bottom: 1px solid var(--border); vertical-align: middle;
  }
  .sessions-table tbody tr { cursor: pointer; transition: background 0.1s; }
  .sessions-table tbody tr:hover td { background: #FAFBFF; }
  .sessions-table tbody tr:last-child td { border-bottom: none; }
  .prompt-preview {
    max-width: 340px; overflow: hidden; text-overflow: ellipsis;
    white-space: nowrap; font-weight: 500;
  }
  .token-num {
    font-family: var(--mono); font-size: 13px; font-weight: 600;
    text-align: right; white-space: nowrap; letter-spacing: -0.3px;
  }
  .model-badge {
    display: inline-flex; align-items: center; gap: 5px;
    padding: 3px 10px; border-radius: 20px;
    font-size: 12px; font-weight: 600;
    transition: box-shadow 0.15s;
  }
  .model-badge:focus-visible { outline: 2px solid var(--indigo); outline-offset: 2px; }
  /* Contrast-corrected badge colors (WCAG AA compliant) */
  .model-opus { background: #EEF2FF; color: #3730A3; }
  .model-sonnet { background: #ECFDF5; color: #047857; }
  .model-haiku { background: #FFF7ED; color: #C2410C; }
  .model-unknown { background: #F1F5F9; color: #475569; }
  .model-dot { width: 6px; height: 6px; border-radius: 50%; flex-shrink: 0; }
  .model-opus .model-dot { background: #4F46E5; }
  .model-sonnet .model-dot { background: #10B981; }
  .model-haiku .model-dot { background: #F97316; }
  /* Sub-line pills in project rows — compact variant */
  .model-pills {
    list-style: none; padding: 0; margin: 5px 0 0;
    display: flex; flex-wrap: wrap; gap: 4px;
  }
  .model-pills li { display: flex; }
  .model-pills .model-badge {
    padding: 2px 8px; font-size: 11px; border-radius: 10px;
  }
  /* Screen-reader-only label (WCAG 2.1 compliant) */
  .sr-only {
    position: absolute; width: 1px; height: 1px; padding: 0;
    margin: -1px; overflow: hidden; clip: rect(0,0,0,0);
    white-space: nowrap; border-width: 0;
  }
  /* Inline ↓in ↑out token pair inside a model badge */
  .token-detail {
    display: inline-flex; align-items: center; gap: 2px;
    font-size: 10px; font-weight: 600; opacity: 0.9;
  }
  /* Project name styled as path */
  .proj-name {
    font-weight: 600; font-size: 13px;
    font-family: var(--mono); letter-spacing: -0.2px; color: var(--text);
  }
  .date-cell { white-space: nowrap; color: var(--text-secondary); font-weight: 500; }
  .project-tag {
    font-size: 11px; color: var(--text-tertiary); display: block;
    margin-top: 1px; font-weight: 500;
    max-width: 100px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;
  }

  /* ---- DRILLDOWN ---- */
  .drilldown {
    background: var(--white); border-radius: var(--radius);
    padding: 28px; margin-bottom: 32px; display: none;
    border: 1px solid var(--border); box-shadow: var(--shadow-lg);
  }
  .drilldown.open { display: block; animation: fadeUp 0.3s ease-out; }
  .drilldown-header {
    display: flex; align-items: flex-start; justify-content: space-between;
    margin-bottom: 24px; gap: 16px;
  }
  .drilldown-title { font-size: 16px; font-weight: 700; line-height: 1.4; }
  .drilldown-meta { font-size: 13px; color: var(--text-tertiary); margin-top: 4px; font-weight: 500; }
  .drilldown-close {
    background: var(--bg); border: none; color: var(--text-secondary);
    width: 32px; height: 32px; border-radius: 8px; cursor: pointer;
    font-size: 18px; display: flex; align-items: center; justify-content: center;
    flex-shrink: 0; transition: all 0.15s;
  }
  .drilldown-close:hover { background: #EEF2FF; color: var(--indigo); }

  .query-list { display: flex; flex-direction: column; gap: 8px; }
  .query-item {
    display: grid; grid-template-columns: 36px 1fr auto;
    gap: 14px; padding: 14px 16px; border-radius: var(--radius-sm);
    background: var(--bg); align-items: start;
    transition: background 0.1s;
  }
  .query-item:hover { background: #EEF2FF; }
  .query-num {
    width: 28px; height: 28px; border-radius: 8px; background: var(--white);
    border: 1px solid var(--border);
    font-size: 12px; font-weight: 700; color: var(--text-tertiary);
    display: flex; align-items: center; justify-content: center;
  }
  .query-prompt { font-size: 14px; font-weight: 500; line-height: 1.5; word-break: break-word; }
  .query-prompt.no-prompt { color: var(--text-tertiary); font-style: italic; font-weight: 400; }
  .query-tokens-col { display: flex; flex-direction: column; align-items: flex-end; gap: 2px; white-space: nowrap; }
  .query-tokens-col .total { font-family: var(--mono); font-size: 14px; font-weight: 700; }
  .query-tokens-col .detail { font-size: 12px; color: var(--text-tertiary); font-weight: 500; }

  /* ---- FOOTER ---- */
  .footer {
    text-align: center; padding: 24px;
    color: var(--text-tertiary); font-size: 13px; font-weight: 500;
  }
  .footer a { color: var(--indigo); text-decoration: none; font-weight: 600; }
  .footer a:hover { text-decoration: underline; }

  /* Privacy notice */
  .privacy-notice {
    display: flex; align-items: center; justify-content: center; gap: 6px;
    font-size: 13px; font-weight: 500; color: var(--text-secondary);
    background: rgba(99,102,241,0.06); border: 1px solid rgba(99,102,241,0.1);
    padding: 8px 16px; border-radius: 10px; margin-bottom: 20px;
  }

  /* Hero / value prop */
  .hero-section {
    text-align: center; margin-bottom: 36px; padding: 0 20px;
  }
  .hero-title {
    font-size: 38px; font-weight: 800; letter-spacing: -1.5px;
    background: var(--gradient-main); -webkit-background-clip: text;
    -webkit-text-fill-color: transparent; background-clip: text;
    margin-bottom: 10px; line-height: 1.3;
  }
  .hero-subtitle {
    font-size: 15px; color: var(--text-secondary); font-weight: 500;
    max-width: 600px; margin: 0 auto; line-height: 1.7;
  }
</style>
</head>
<body>

<div id="loading" class="loading">
  <div class="spinner"></div>
  <div class="loading-text">Reading your Claude Code sessions...</div>
</div>

<div id="app" class="container" style="display:none">

  <!-- Privacy notice -->
  <div class="privacy-notice animate">
    &#128274; All data stays on your machine. Nothing is sent anywhere.
  </div>

  <!-- Header -->
  <div class="header animate">
    <div class="header-left">
      <div class="logo-mark">
        <svg viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round"><path d="M12 2L2 7l10 5 10-5-10-5z"/><path d="M2 17l10 5 10-5"/><path d="M2 12l10 5 10-5"/></svg>
      </div>
      <h1>Claude Spend</h1>
    </div>
    <div class="header-right">
      <span id="dateRange" class="date-range"></span>
      <button class="refresh-btn" onclick="refreshData()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"><path d="M1 4v6h6"/><path d="M3.51 15a9 9 0 1 0 2.13-9.36L1 10"/></svg>
        Refresh
      </button>
    </div>
  </div>

  <!-- Value proposition -->
  <div class="hero-section animate delay-1">
    <h2 class="hero-title">Your Claude Code usage, visualized.</h2>
    <p class="hero-subtitle">See where your tokens actually go.</p>
  </div>

  <!-- Stats -->
  <div class="stats-row" id="statsRow"></div>

  <!-- Insights -->
  <div id="insightsSection" class="insights-section" style="display:none">
    <div class="section-header animate">
      <div class="section-icon" style="background:linear-gradient(135deg,#FEF3C7,#FDE68A)">
        <svg viewBox="0 0 24 24" fill="none" stroke="#D97706" stroke-width="2.5" stroke-linecap="round"><path d="M12 2a7 7 0 0 1 4 12.75V17a1 1 0 0 1-1 1H9a1 1 0 0 1-1-1v-2.25A7 7 0 0 1 12 2z"/><path d="M9 21h6"/></svg>
      </div>
      <div class="section-title">Insights</div>
    </div>
    <div id="insightsList"></div>
  </div>

  <!-- Charts -->
  <div class="charts-grid animate delay-3">
    <div class="chart-card">
      <h3 class="has-tooltip has-tooltip-below" style="display:inline-block">Tokens per Day<div class="tooltip">How many tokens you used each day. Indigo = fresh input + cache writes (full price), amber = cache reads (10x cheaper), teal = Claude's output.</div></h3>
      <canvas id="dailyChart"></canvas>
      <div class="legend">
        <div class="legend-item"><div class="legend-dot" style="background:var(--indigo)"></div> Fresh input (full price)</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--amber)"></div> Cache reads (10x cheaper)</div>
        <div class="legend-item"><div class="legend-dot" style="background:var(--teal)"></div> Claude's output</div>
      </div>
    </div>
    <div class="chart-card">
      <h3>By Model</h3>
      <canvas id="modelChart"></canvas>
      <div id="modelLegend" class="legend" style="flex-direction:column; gap:12px; margin-top:20px;"></div>
    </div>
  </div>

  <!-- Projects (temporarily hidden - TODO: fix prompt extraction) -->

  <!-- Most Expensive Prompts -->
  <div class="top-prompts animate delay-4">
    <div class="section-header">
      <div class="section-icon" style="background:linear-gradient(135deg,#E0E7FF,#C7D2FE)">
        <svg viewBox="0 0 24 24" fill="none" stroke="#6366F1" stroke-width="2.5" stroke-linecap="round"><path d="M12 20V10"/><path d="M18 20V4"/><path d="M6 20v-4"/></svg>
      </div>
      <div class="section-title has-tooltip has-tooltip-below" style="display:inline-flex">Most Expensive Prompts<div class="tooltip">Your top 20 individual messages ranked by how many tokens they used. Short vague messages like "Yes" often rank highest because they trigger long chains of tool calls where Claude tries to figure out what you meant.</div></div>
    </div>
    <div class="prompts-card" id="topPromptsList"></div>
  </div>

  <!-- Drill-down -->
  <div id="drilldown" class="drilldown">
    <div class="drilldown-header">
      <div>
        <div id="drilldownTitle" class="drilldown-title"></div>
        <div id="drilldownMeta" class="drilldown-meta"></div>
      </div>
      <button class="drilldown-close" onclick="closeDrilldown()">&times;</button>
    </div>
    <div id="queryList" class="query-list"></div>
  </div>

  <!-- All Sessions -->
  <div class="sessions-section animate delay-5">
    <div class="section-header">
      <div class="section-icon" style="background:linear-gradient(135deg,#ECFDF5,#D1FAE5)">
        <svg viewBox="0 0 24 24" fill="none" stroke="#059669" stroke-width="2.5" stroke-linecap="round"><rect x="3" y="4" width="18" height="18" rx="2"/><path d="M16 2v4"/><path d="M8 2v4"/><path d="M3 10h18"/></svg>
      </div>
      <div class="section-title">All Sessions</div>
    </div>
    <div class="sessions-toolbar">
      <input type="text" class="session-search" id="searchInput" placeholder="Search prompts, models, projects...">
      <span id="sessionCount" class="session-count"></span>
    </div>
    <div class="sessions-card">
      <table class="sessions-table">
        <thead>
          <tr>
            <th data-sort="date">Date</th>
            <th data-sort="prompt">What you asked</th>
            <th data-sort="model" class="has-tooltip has-tooltip-below">Model<div class="tooltip">Which AI model was used. Opus is the most capable (and uses more tokens), Sonnet is faster and lighter.</div></th>
            <th data-sort="queries" style="text-align:right" class="has-tooltip has-tooltip-below">Messages<div class="tooltip">How many back-and-forth messages happened in this conversation, including automatic tool calls Claude made.</div></th>
            <th data-sort="total" style="text-align:right" class="sorted has-tooltip has-tooltip-below">Total tokens<div class="tooltip">The total number of tokens used in this conversation. Higher means more expensive. Long conversations cost more because Claude re-reads everything each turn.</div></th>
            <th data-sort="input" style="text-align:right" class="has-tooltip has-tooltip-below">Read<div class="tooltip">Tokens Claude read: your messages, the conversation history, files, and system context. This grows with each message because the full history gets re-sent.</div></th>
            <th data-sort="output" style="text-align:right" class="has-tooltip has-tooltip-below">Written<div class="tooltip">Tokens Claude wrote back: responses, code, explanations. Usually a small fraction of the total.</div></th>
          </tr>
        </thead>
        <tbody id="sessionsBody"></tbody>
      </table>
    </div>
  </div>

  <div class="footer">
    <div style="margin-bottom: 8px; color: var(--text-secondary); font-size: 13px;">This tool runs 100% locally -- no analytics, no tracking. If you find it useful (or not), I'd love to hear from you at <a href="mailto:writetoaniketparihar@gmail.com">writetoaniketparihar@gmail.com</a></div>
    Made with <a href="https://claude.ai/code" target="_blank">Claude Code</a> and &#10084; by <a href="https://www.linkedin.com/in/aniketparihar/" target="_blank">Aniket</a>
  </div>
</div>

<script>
let DATA = null;
let currentSort = { key: 'total', dir: 'desc' };
let searchQuery = '';

function fmt(n) {
  if (n >= 1_000_000) return (n / 1_000_000).toFixed(1) + 'M';
  if (n >= 10_000) return (n / 1_000).toFixed(0) + 'K';
  if (n >= 1_000) return (n / 1_000).toFixed(1) + 'K';
  return n.toLocaleString();
}
function fmtFull(n) { return n.toLocaleString(); }

function modelClass(m) {
  if (m.includes('opus')) return 'model-opus';
  if (m.includes('sonnet')) return 'model-sonnet';
  if (m.includes('haiku')) return 'model-haiku';
  return 'model-unknown';
}
function modelShort(m) {
  // New format: claude-{family}-{major}-{minor}[-date]
  // e.g. claude-opus-4-6, claude-sonnet-4-6, claude-haiku-4-5-20251001
  let match = m.match(/^claude-(opus|sonnet|haiku)-(\d+)-(\d+)/i);
  if (match) {
    const name = match[1].charAt(0).toUpperCase() + match[1].slice(1);
    return name + ' ' + match[2] + '.' + match[3];
  }
  // Old format with sub-version: claude-3-5-{family} or claude-3-7-{family}
  match = m.match(/^claude-(\d+)-(\d+)-(opus|sonnet|haiku)/i);
  if (match) {
    const name = match[3].charAt(0).toUpperCase() + match[3].slice(1);
    return name + ' ' + match[1] + '.' + match[2];
  }
  // Old format: claude-3-{family}
  match = m.match(/^claude-(\d+)-(opus|sonnet|haiku)/i);
  if (match) {
    const name = match[2].charAt(0).toUpperCase() + match[2].slice(1);
    return name + ' ' + match[1];
  }
  if (m.includes('opus')) return 'Opus';
  if (m.includes('sonnet')) return 'Sonnet';
  if (m.includes('haiku')) return 'Haiku';
  return m;
}
function projectShort(p) {
  // Strip Windows drive prefix (e.g. D-- or C--)
  let s = p.replace(/^[A-Za-z]--/, '');
  // Iteratively strip known parent directory segments
  const known = /^(?:Users|home|user)-[^-]+-|^(?:GitHub|GitLab|git|Projects|projects|workspace|Workspace|Desktop|Documents|source|src|dev|Dev|code|Code|repos|Repos)-/;
  let prev;
  do { prev = s; s = s.replace(known, ''); } while (s !== prev && s.length > 0);
  return s || p;
}
function projectFull(p) {
  // Show the raw encoded name with Windows drive restored for readability
  return p.replace(/^([A-Za-z])--/, '$1:\\');
}
function escapeHtml(s) {
  const d = document.createElement('div'); d.textContent = s; return d.innerHTML;
}
function formatDate(d) {
  if (!d) return '';
  const parts = d.split('-');
  const months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
  return `${months[parseInt(parts[1])-1]} ${parseInt(parts[2])}`;
}

async function fetchData() {
  try {
    const res = await fetch('/api/data');
    const json = await res.json();
    if (!res.ok || json.error) {
      showError(json.error || `Server returned ${res.status}`);
      return;
    }
    if (!json.totals || !json.sessions) {
      showError('No session data found. Make sure you have used Claude Code at least once.');
      return;
    }
    DATA = json;
    render();
  } catch (err) {
    showError('Failed to load data: ' + err.message);
  }
}
function showError(msg) {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('app').style.display = 'none';
  let el = document.getElementById('error-display');
  if (!el) {
    el = document.createElement('div');
    el.id = 'error-display';
    el.style.cssText = 'max-width:600px;margin:80px auto;padding:32px;text-align:center;font-family:inherit;';
    document.body.appendChild(el);
  }
  el.innerHTML = '<div style="font-size:48px;margin-bottom:16px">&#9888;&#65039;</div>' +
    '<h2 style="margin:0 0 12px;color:#1a1a2e">Something went wrong</h2>' +
    '<p style="color:#64748b;margin:0 0 20px;line-height:1.6">' + msg.replace(/</g, '&lt;') + '</p>' +
    '<button onclick="location.reload()" style="padding:8px 20px;border-radius:8px;border:1px solid #e2e8f0;background:#fff;cursor:pointer;font-size:14px">Retry</button>';
}
async function refreshData() {
  document.getElementById('loading').style.display = 'flex';
  document.getElementById('app').style.display = 'none';
  const errEl = document.getElementById('error-display');
  if (errEl) errEl.remove();
  try { await fetch('/api/refresh'); } catch {}
  await fetchData();
}

function render() {
  document.getElementById('loading').style.display = 'none';
  document.getElementById('app').style.display = 'block';
  renderStats();
  renderInsights();
  renderDailyChart();
  renderModelChart();
  // renderProjectBreakdown(); // temporarily disabled
  renderTopPrompts();
  renderSessions();
}

// Stats
function renderStats() {
  const t = DATA.totals;
  const range = t.dateRange ? `${formatDate(t.dateRange.from)} - ${formatDate(t.dateRange.to)}` : '';
  document.getElementById('dateRange').textContent = range;

  const cacheTotal = (t.totalCacheCreationTokens || 0) + (t.totalCacheReadTokens || 0);
  const avgTokensPerMsg = t.totalQueries > 0 ? Math.round(t.totalTokens / t.totalQueries) : 0;

  const cards = [
    { label: 'Total Usage', value: fmt(t.totalTokens), sub: `${fmt(t.totalInputTokens)} input + ${fmt(cacheTotal)} cached + ${fmt(t.totalOutputTokens)} output`,
      tip: 'The total number of tokens used across all your conversations. Input = fresh context sent at full price. Cached = context reused from previous turns at 10x lower cost. Output = what Claude wrote back.' },
    { label: 'Conversations', value: fmtFull(t.totalSessions), sub: `Each one used ~${fmt(t.avgTokensPerSession)} tokens on average`,
      tip: 'Each time you start Claude Code and begin chatting, that counts as one conversation. A new conversation starts fresh with no prior context.' },
    { label: 'Messages Sent', value: fmtFull(t.totalQueries), sub: `Each message used ~${fmt(avgTokensPerMsg)} tokens on average`,
      tip: 'Every time you hit Enter and send something to Claude, that is one message. This includes follow-up tool calls Claude makes automatically behind the scenes.' },
    { label: 'Cache Hit Rate', value: `${((t.cacheHitRate || 0) * 100).toFixed(0)}%`, sub: `${fmt(t.totalCacheReadTokens || 0)} tokens served from cache`,
      tip: 'The percentage of input tokens that were served from cache instead of being processed fresh. Higher is better -- cached tokens are 10x cheaper and help you stay under rate limits.' },
  ];

  document.getElementById('statsRow').innerHTML = cards.map((c, i) => `
    <div class="stat-card animate delay-${i + 1}">
      <div class="stat-label has-tooltip">${c.label}<span class="help-icon">?</span><div class="tooltip">${c.tip}</div></div>
      <div class="stat-value">${c.value}</div>
      <div class="stat-sub">${c.sub}</div>
    </div>`).join('');
}

// Insights
function renderInsights() {
  const insights = DATA.insights || [];
  const section = document.getElementById('insightsSection');
  if (!insights.length) { section.style.display = 'none'; return; }

  section.style.display = 'block';
  const icons = { warning: '!', info: 'i', neutral: '~' };
  const emojis = { warning: '\u26A0\uFE0F', info: '\uD83D\uDCA1', neutral: '\uD83D\uDCC5' };

  document.getElementById('insightsList').innerHTML = insights.map((ins, i) => {
    const detailHtml = ins.description ? `<div class="insight-detail">${escapeHtml(ins.description)}</div>` : '';
    const actionHtml = ins.action ? `<div class="insight-action-tip">${escapeHtml(ins.action)}</div>` : '';
    return `<div class="insight-card ${ins.type} animate delay-${Math.min(i + 2, 5)}" onclick="this.classList.toggle('expanded')">
      <div class="insight-top">
        <div class="insight-indicator">${emojis[ins.type] || ''}</div>
        <div class="insight-title">${escapeHtml(ins.title)}</div>
        <div class="insight-arrow"><svg width="12" height="12" viewBox="0 0 12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"><path d="M3 4.5L6 7.5L9 4.5"/></svg></div>
      </div>
      <div class="insight-expand">
        ${detailHtml}
        ${actionHtml}
      </div>
    </div>`;
  }).join('');
}

// Daily chart -- 3 color stacked bars
function renderDailyChart() {
  const canvas = document.getElementById('dailyChart');
  const ctx = canvas.getContext('2d');
  const data = DATA.dailyUsage;
  if (!data.length) return;

  const dpr = window.devicePixelRatio || 1;
  const w = canvas.parentElement.clientWidth - 48;
  const h = 200;
  canvas.width = w * dpr; canvas.height = h * dpr;
  canvas.style.width = w + 'px'; canvas.style.height = h + 'px';
  ctx.scale(dpr, dpr);
  ctx.clearRect(0, 0, w, h);

  const maxTotal = Math.max(...data.map(d => d.totalTokens));
  const barW = Math.max(8, Math.min(32, (w - 52) / data.length - 3));
  const gap = 3;
  const chartH = h - 36;
  const startX = 48;

  // Grid
  ctx.font = '500 10px Inter, system-ui';
  ctx.fillStyle = '#94A3B8';
  ctx.textAlign = 'right';
  for (let i = 0; i <= 4; i++) {
    const val = (maxTotal / 4) * i;
    const y = chartH - (chartH * i / 4) + 8;
    ctx.fillText(fmt(val), startX - 10, y + 3);
    ctx.strokeStyle = 'rgba(0,0,0,0.04)'; ctx.lineWidth = 1;
    ctx.beginPath(); ctx.moveTo(startX, y); ctx.lineTo(w, y); ctx.stroke();
  }

  // Gradients
  const inGrad = ctx.createLinearGradient(0, chartH + 8, 0, 0);
  inGrad.addColorStop(0, '#818CF8'); inGrad.addColorStop(1, '#6366F1');
  const cacheGrad = ctx.createLinearGradient(0, chartH + 8, 0, 0);
  cacheGrad.addColorStop(0, '#FBBF24'); cacheGrad.addColorStop(1, '#F59E0B');
  const outGrad = ctx.createLinearGradient(0, chartH + 8, 0, 0);
  outGrad.addColorStop(0, '#2DD4BF'); outGrad.addColorStop(1, '#14B8A6');

  data.forEach((d, i) => {
    const x = startX + i * (barW + gap);
    const baseY = chartH + 8;
    const r = Math.min(4, barW / 2);

    // Bottom: output (teal)
    const outH = (d.outputTokens / maxTotal) * chartH;
    if (outH > 0) {
      ctx.fillStyle = outGrad;
      ctx.beginPath(); roundedRect(ctx, x, baseY - outH, barW, outH, r); ctx.fill();
    }

    // Middle: cache reads (amber)
    const cacheH = ((d.cacheReadTokens || 0) / maxTotal) * chartH;
    if (cacheH > 0) {
      ctx.fillStyle = cacheGrad;
      ctx.beginPath(); roundedRect(ctx, x, baseY - outH - cacheH, barW, cacheH, 0); ctx.fill();
    }

    // Top: input + cache creation (indigo)
    const freshH = ((d.inputTokens + (d.cacheCreationTokens || 0)) / maxTotal) * chartH;
    if (freshH > 0) {
      ctx.fillStyle = inGrad;
      ctx.beginPath(); roundedRect(ctx, x, baseY - outH - cacheH - freshH, barW, freshH, r); ctx.fill();
    }
  });

  // X labels
  ctx.fillStyle = '#94A3B8'; ctx.textAlign = 'center';
  ctx.font = '500 10px Inter, system-ui';
  const step = Math.max(1, Math.floor(data.length / 7));
  data.forEach((d, i) => {
    if (i % step === 0 || i === data.length - 1) {
      const x = startX + i * (barW + gap) + barW / 2;
      ctx.fillText(formatDate(d.date), x, chartH + 24);
    }
  });
}

function roundedRect(ctx, x, y, w, h, r) {
  if (h <= 0) return;
  r = Math.min(r, h / 2, w / 2);
  ctx.moveTo(x + r, y);
  ctx.lineTo(x + w - r, y);
  ctx.quadraticCurveTo(x + w, y, x + w, y + r);
  ctx.lineTo(x + w, y + h - r);
  ctx.quadraticCurveTo(x + w, y + h, x + w - r, y + h);
  ctx.lineTo(x + r, y + h);
  ctx.quadraticCurveTo(x, y + h, x, y + h - r);
  ctx.lineTo(x, y + r);
  ctx.quadraticCurveTo(x, y, x + r, y);
  ctx.closePath();
}

// Model donut
function renderModelChart() {
  const canvas = document.getElementById('modelChart');
  const ctx = canvas.getContext('2d');
  const data = DATA.modelBreakdown;
  if (!data.length) return;

  const dpr = window.devicePixelRatio || 1;
  const size = Math.min(180, canvas.parentElement.clientWidth - 48);
  canvas.width = size * dpr; canvas.height = size * dpr;
  canvas.style.width = size + 'px'; canvas.style.height = size + 'px';
  ctx.scale(dpr, dpr);

  const cx = size/2, cy = size/2, r = size/2 - 6, innerR = r * 0.6;
  const total = data.reduce((s, d) => s + d.totalTokens, 0);

  const modelColors = { opus: ['#6366F1','#818CF8'], sonnet: ['#10B981','#34D399'], haiku: ['#F97316','#FB923C'] };
  function getColors(m) {
    for (const [k, c] of Object.entries(modelColors)) { if (m.includes(k)) return c; }
    return ['#94A3B8','#CBD5E1'];
  }

  let angle = -Math.PI / 2;
  const slices = [...data].sort((a, b) => b.totalTokens - a.totalTokens);

  slices.forEach(d => {
    const sa = (d.totalTokens / total) * Math.PI * 2;
    const [c1, c2] = getColors(d.model);
    const grad = ctx.createConicGradient(angle, cx, cy);
    grad.addColorStop(0, c1); grad.addColorStop(1, c2);

    ctx.beginPath();
    ctx.arc(cx, cy, r, angle, angle + sa);
    ctx.arc(cx, cy, innerR, angle + sa, angle, true);
    ctx.closePath();
    ctx.fillStyle = c1;
    ctx.fill();

    // Gap between slices
    ctx.strokeStyle = '#FFFFFF'; ctx.lineWidth = 2; ctx.stroke();
    angle += sa;
  });

  ctx.fillStyle = '#0F172A'; ctx.textAlign = 'center';
  ctx.font = '800 17px Inter, system-ui';
  ctx.fillText(fmt(total), cx, cy + 2);
  ctx.font = '500 10px Inter, system-ui';
  ctx.fillStyle = '#94A3B8';
  ctx.fillText('total', cx, cy + 16);

  document.getElementById('modelLegend').innerHTML = slices.map(d => {
    const pct = ((d.totalTokens / total) * 100).toFixed(1);
    return `<div class="legend-item">
      <div class="legend-dot" style="background:${getColors(d.model)[0]}"></div>
      <span><strong>${modelShort(d.model)}</strong> &ndash; ${fmt(d.totalTokens)} (${pct}%)</span>
    </div>`;
  }).join('');
}

// Project accordion
function toggleProjectDrawer(i) {
  const row = document.getElementById('proj-row-' + i);
  const drawer = document.getElementById('proj-drawer-' + i);
  const isOpen = drawer.classList.contains('open');
  row.classList.toggle('expanded', !isOpen);
  drawer.classList.toggle('open', !isOpen);
}

function buildDrawerContent(p) {
  if (!p.topPrompts || p.topPrompts.length === 0) {
    return '<div class="drawer-empty">No prompt data available</div>';
  }
  const items = p.topPrompts.map((pr, i) => {
    const toolEntries = Object.entries(pr.toolCounts || {}).sort((a, b) => b[1] - a[1]);
    const chips = toolEntries.map(([name, count]) =>
      '<span class="tool-chip">' + count + '\u00d7\u00a0' + escapeHtml(name) + '</span>'
    ).join('') + (pr.continuations > 0 ? '<span class="tool-chip">+' + pr.continuations + ' turns</span>' : '');
    const badge = '<span class="model-badge ' + modelClass(pr.model) + '"><span class="model-dot"></span>' + modelShort(pr.model) + '</span>';
    const tokVal = fmt(pr.totalTokens);
    const tokSub = fmt(pr.inputTokens) + ' / ' + fmt(pr.outputTokens);
    const promptText = escapeHtml(pr.prompt);
    const sid = pr.sessionId;
    return [
      '<div class="drawer-prompt-row" onclick="openDrilldown(\'' + sid + '\')">',
      '<div class="drawer-rank">' + (i + 1) + '</div>',
      '<div>',
      '<div class="drawer-prompt-text">' + promptText + '</div>',
      '<div class="drawer-prompt-meta">' + badge + chips + '</div>',
      '</div>',
      '<div class="drawer-tokens"><div class="value">' + tokVal + '</div><div class="sub">' + tokSub + '</div></div>',
      '</div>',
    ].join('');
  });
  return '<div class="drawer-prompt-list">' + items.join('') + '</div>';
}

// Project breakdown
function renderProjectBreakdown() {
  const projects = DATA.projectBreakdown;
  if (!projects || !projects.length) return;

  const countEl = document.getElementById('projectsCount');
  countEl.textContent = projects.length + ' project' + (projects.length === 1 ? '' : 's');

  const maxTokens = projects[0].totalTokens;
  const chevron = '<svg class="proj-chevron" viewBox="0 0 20 20" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M8 6l4 4-4 4"/></svg>';
  const rows = [];
  projects.forEach((p, i) => {
    const barPct = (p.totalTokens / maxTokens * 100).toFixed(1);
    const ariaLabel = p.modelBreakdown.map(m => modelShort(m.model) + ': ' + fmt(m.inputTokens) + ' input, ' + fmt(m.outputTokens) + ' output').join(', ');
    const pillItems = p.modelBreakdown.map(m =>
      '<li><span class="model-badge ' + modelClass(m.model) +
      '" aria-label="' + modelShort(m.model) + ': ' + fmt(m.inputTokens) + ' input, ' + fmt(m.outputTokens) + ' output">' +
      '<span class="model-dot" aria-hidden="true"></span>' +
      modelShort(m.model) +
      ' <span class="token-detail"><span aria-hidden="true">\u2193</span><span class="sr-only">in </span>' + fmt(m.inputTokens) + '</span>' +
      ' <span class="token-detail"><span aria-hidden="true">\u2191</span><span class="sr-only">out </span>' + fmt(m.outputTokens) + '</span>' +
      '</span></li>'
    ).join('');
    const summaryRow = [
      '<tr class="proj-row" id="proj-row-' + i + '" onclick="toggleProjectDrawer(' + i + ')">',
      '<td style="padding:10px 16px">',
      '<div style="display:flex;align-items:center;gap:6px">',
      chevron,
      '<div>',
      '<div class="proj-name" title="' + projectFull(p.project) + '">' + escapeHtml(projectShort(p.project)) + '</div>',
      '<ul class="model-pills" aria-label="Models used: ' + ariaLabel + '">' + pillItems + '</ul>',
      '</div></div></td>',
      '<td class="token-num" style="font-weight:700;vertical-align:top;padding-top:12px">',
      '<div style="display:flex;align-items:center;gap:8px;justify-content:flex-end">',
      '<div style="flex:1;max-width:60px;height:3px;background:var(--bg);border-radius:4px;overflow:hidden">',
      '<div style="width:' + barPct + '%;height:100%;background:var(--indigo);border-radius:4px"></div>',
      '</div><div><div>' + fmt(p.totalTokens) + '</div><div style="font-size:11px;font-weight:500;color:var(--text-tertiary);margin-top:1px">' + fmt(p.inputTokens) + ' in\u00a0\u00b7\u00a0' + fmt(p.outputTokens) + ' out</div></div></div></td>',
      '<td class="token-num" style="vertical-align:top;padding-top:12px">' + p.sessionCount + '</td>',
      '<td class="token-num" style="vertical-align:top;padding-top:12px">' + p.queryCount + '</td>',
      '</tr>',
    ].join('');
    const drawerRow = [
      '<tr class="proj-drawer" id="proj-drawer-' + i + '">',
      '<td colspan="4"><div class="proj-drawer-inner"><div class="proj-drawer-content">',
      buildDrawerContent(p),
      '</div></div></td></tr>',
    ].join('');
    rows.push(summaryRow, drawerRow);
  });
  document.getElementById('projectsBody').innerHTML = rows.join('');
}

// Top prompts
function renderTopPrompts() {
  const prompts = DATA.topPrompts;
  if (!prompts.length) return;
  const maxTokens = prompts[0].totalTokens;

  document.getElementById('topPromptsList').innerHTML = prompts.map((p, i) => {
    const freshIn = p.inputTokens + (p.cacheCreationTokens || 0);
    const cached = p.cacheReadTokens || 0;
    const total = freshIn + cached + p.outputTokens;
    const freshPct = total > 0 ? (freshIn / total) * 100 : 0;
    const cachePct = total > 0 ? (cached / total) * 100 : 0;
    const outPct = total > 0 ? (p.outputTokens / total) * 100 : 0;
    return `<div class="prompt-row" onclick="openDrilldown('${p.sessionId}')">
      <div class="prompt-rank">${i + 1}</div>
      <div>
        <div class="prompt-text">${escapeHtml(p.prompt)}</div>
        <div class="prompt-meta">${formatDate(p.date)} &middot; ${modelShort(p.model)}</div>
        <div class="token-bar-wrap" style="width:${Math.max(10, (p.totalTokens / maxTokens) * 100)}%">
          <div class="token-bar-in" style="width:${freshPct}%"></div>
          <div class="token-bar-cache" style="width:${cachePct}%"></div>
          <div class="token-bar-out" style="width:${outPct}%"></div>
        </div>
      </div>
      <div class="prompt-tokens">
        <div style="font-family:var(--mono);font-size:14px;font-weight:700;color:var(--indigo)">${fmt(p.totalTokens)}</div>
        <div class="sub">${fmt(p.inputTokens)} in / ${fmt(cached)} cached / ${fmt(p.outputTokens)} out</div>
      </div>
    </div>`;
  }).join('');
}

// Sessions
function renderSessions() {
  let sessions = [...DATA.sessions];
  if (searchQuery) {
    const q = searchQuery.toLowerCase();
    sessions = sessions.filter(s =>
      s.firstPrompt.toLowerCase().includes(q) ||
      s.model.toLowerCase().includes(q) ||
      projectShort(s.project).toLowerCase().includes(q)
    );
  }

  const sortFns = {
    date: (a, b) => (a.timestamp || '').localeCompare(b.timestamp || ''),
    prompt: (a, b) => a.firstPrompt.localeCompare(b.firstPrompt),
    model: (a, b) => a.model.localeCompare(b.model),
    queries: (a, b) => a.queryCount - b.queryCount,
    total: (a, b) => a.totalTokens - b.totalTokens,
    input: (a, b) => a.inputTokens - b.inputTokens,
    output: (a, b) => a.outputTokens - b.outputTokens,
  };
  const fn = sortFns[currentSort.key] || sortFns.total;
  sessions.sort((a, b) => currentSort.dir === 'desc' ? fn(b, a) : fn(a, b));

  document.getElementById('sessionCount').textContent = `${sessions.length} sessions`;

  document.getElementById('sessionsBody').innerHTML = sessions.map(s => `
    <tr onclick="openDrilldown('${s.sessionId}')">
      <td class="date-cell">
        ${formatDate(s.date)}
        <span class="project-tag" title="${escapeHtml(projectShort(s.project))}">${escapeHtml(projectShort(s.project))}</span>
      </td>
      <td><div class="prompt-preview" title="${escapeHtml(s.firstPrompt)}">${escapeHtml(s.firstPrompt)}</div></td>
      <td><span class="model-badge ${modelClass(s.model)}"><span class="model-dot"></span>${modelShort(s.model)}</span></td>
      <td class="token-num">${s.queryCount}</td>
      <td class="token-num" style="font-weight:700">${fmt(s.totalTokens)}</td>
      <td class="token-num">${fmt(s.inputTokens)}</td>
      <td class="token-num">${fmt(s.outputTokens)}</td>
    </tr>
  `).join('');
}

// Sort
document.querySelectorAll('.sessions-table th[data-sort]').forEach(th => {
  th.addEventListener('click', () => {
    const key = th.dataset.sort;
    if (currentSort.key === key) { currentSort.dir = currentSort.dir === 'desc' ? 'asc' : 'desc'; }
    else { currentSort = { key, dir: 'desc' }; }
    document.querySelectorAll('.sessions-table th').forEach(t => t.classList.remove('sorted'));
    th.classList.add('sorted');
    renderSessions();
  });
});

document.getElementById('searchInput').addEventListener('input', e => {
  searchQuery = e.target.value;
  renderSessions();
});

// Drill-down
function openDrilldown(sessionId) {
  const session = DATA.sessions.find(s => s.sessionId === sessionId);
  if (!session) return;

  document.getElementById('drilldownTitle').textContent = session.firstPrompt.substring(0, 140);
  document.getElementById('drilldownMeta').textContent =
    `${formatDate(session.date)} \u00B7 ${modelShort(session.model)} \u00B7 ${session.queryCount} messages \u00B7 ${fmt(session.totalTokens)} tokens`;

  const grouped = [];
  let current = null;
  for (const q of session.queries) {
    if (q.userPrompt) {
      if (current) grouped.push(current);
      current = {
        prompt: q.userPrompt,
        inputTokens: q.inputTokens,
        outputTokens: q.outputTokens,
        cacheCreationTokens: q.cacheCreationTokens || 0,
        cacheReadTokens: q.cacheReadTokens || 0,
        totalTokens: q.totalTokens,
        cost: q.cost || 0,
        continuations: 0,
      };
    } else if (current) {
      current.inputTokens += q.inputTokens;
      current.outputTokens += q.outputTokens;
      current.cacheCreationTokens += (q.cacheCreationTokens || 0);
      current.cacheReadTokens += (q.cacheReadTokens || 0);
      current.totalTokens += q.totalTokens;
      current.cost += (q.cost || 0);
      current.continuations++;
    }
  }
  if (current) grouped.push(current);

  document.getElementById('queryList').innerHTML = grouped.map((q, i) => {
    const cont = q.continuations > 0 ? ` + ${q.continuations} tool uses` : '';
    const cached = q.cacheReadTokens || 0;
    return `<div class="query-item">
      <div class="query-num">${i + 1}</div>
      <div class="query-prompt">${escapeHtml(q.prompt.substring(0, 500))}</div>
      <div class="query-tokens-col">
        <div class="total">${fmt(q.totalTokens)}</div>
        <div class="detail">${fmt(q.inputTokens)} in / ${fmt(cached)} cached / ${fmt(q.outputTokens)} out${cont}</div>
      </div>
    </div>`;
  }).join('');

  const panel = document.getElementById('drilldown');
  panel.classList.add('open');
  panel.scrollIntoView({ behavior: 'smooth', block: 'start' });
}

function closeDrilldown() {
  document.getElementById('drilldown').classList.remove('open');
}

fetchData();
window.addEventListener('resize', () => { if (DATA) { renderDailyChart(); renderModelChart(); } });
</script>
</body>
</html>
